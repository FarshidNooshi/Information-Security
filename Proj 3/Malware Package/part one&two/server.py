# a server for the malware package
import json
import os
import socket

import pyfiglet


class Server:
    def __init__(self):
        """
        read json_data from config.json file and read IP, port from it
        """
        self.socket = None
        curr_dir_par = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
        with open(os.path.join(curr_dir_par, 'data', 'config.json')) as f:
            json_data = json.load(f)
            # read IP, port from it
            self.ip = json_data['IP']
            self.port = json_data['Port']

    def start(self):
        """
        start the server and listen to the port and IP address from config.json file
        :return: None
        """
        self.socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        self.socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        host = socket.gethostname() if self.ip == 'localhost' else self.ip
        self.socket.bind((host, self.port))
        self.socket.listen(5)

    @staticmethod
    def __get_message(client_socket):
        """
        get a message from the client
        :param client_socket: the client socket
        :return: the message
        """
        return client_socket.recv(2048).decode('utf-8')

    @staticmethod
    def __send_message(msg, client_socket):
        """
        send a message to the client
        :param msg: the message
        :param client_socket: the client socket
        :return: None
        """
        client_socket.send(msg.encode('utf-8'))

    def run(self):
        """
        run the server and wait for a client to connect to it
        :return: None
        """
        while True:
            print('Waiting for a client to connect...')
            client_socket, addr = self.socket.accept()
            print("Got a connection from %s" % str(addr))
            msg = self.__get_message(client_socket)
            print(msg)
            self.__send_message('Thank you for connecting', client_socket)
            client_socket.close()

    def close(self):
        """
        close the server socket
        :return: None
        """
        self.socket.close()

    def __del__(self):
        """
        close the server
        :return: None
        """
        self.close()


if __name__ == '__main__':
    print(pyfiglet.figlet_format('Server'))
    server = Server()
    server.start()
    server.run()
