# a server for the malware package
import json
import socket


class Server:
    def __init__(self):
        # read json_data from json_data.json file
        self.socket = None
        with open('data/data.json') as f:
            json_data = json.load(f)
            # read IP, port from it
            self.ip = json_data['IP']
            self.port = json_data['Port']

    def start(self):
        # create a socket object
        self.socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

        # not close the socket immediately
        self.socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)

        # get local machine name
        host = socket.gethostname() if self.ip == 'localhost' else self.ip

        # bind to the port
        self.socket.bind((host, self.port))

        # queue up to 5 requests
        self.socket.listen(5)

    @staticmethod
    def __get_message(client_socket):
        return client_socket.recv(1024).decode('ascii')

    @staticmethod
    def __send_message(msg, client_socket):
        client_socket.send(msg.encode('ascii'))

    def run(self):
        while True:
            # establish a connection
            client_socket, addr = self.socket.accept()
            print("Got a connection from %s" % str(addr))
            msg = self.__get_message(client_socket)
            print(msg)
            self.__send_message('Thank you for connecting', client_socket)
            client_socket.close()

    def close(self):
        self.socket.close()

    def __del__(self):
        self.close()


if __name__ == '__main__':
    server = Server()
    server.start()
    server.run()
